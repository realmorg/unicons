<custom-element name="icon-list">
  <element-state name="icon-import" type="html"></element-state>
  <element-state name="icon-render" type="html"></element-state>
  <element-state name="is-loading" type="boolean">true</element-state>
  <element-flow>
    <listen-event on="selected-icon-changed">
      <set-state name="icon-render" value=""></set-state>
      <set-state name="icon-import" value=""></set-state>
      <script type="module/realm" use="localState, globalState, ref">
        localState.set('is-loading', true);

        const getLoadedIcons = () => globalState.get('unicons-loaded-icons');
        const selectedIconId = globalState.get('unicons-selected-icon');
        const iconId = 'icon-' + selectedIconId;
        if (!selectedIconId) return;

        const arrChunk = (arr, size) => arr .reduce((acc, _, i) => (i % size) ? acc : [...acc, arr.slice(i, i + size)] , []);
        const isIconElementDefined = (element) => !!customElements.get(`icon-${element}`);

        let info = window[iconId];
        if (!info) {
          const response = await fetch(`/meta/${iconId}.json`);
          window[iconId] = info = await response.json();
        }

        const renderIconElements = () => {
          localState.set('icon-render', info.elements.reduce((acc, element) => {
            if (!isIconElementDefined(element)) return acc;
            return [...acc, `<icon-button><icon-${element}></icon-${element}></icon-button>`]
          }, []).join(''));
          localState.set('is-loading', false);
        }

        const importElements = arrChunk(info.elements, 7);
        const renderElement = (iter = 0) => {
          const imports = importElements[iter];

          localState.set('icon-import', imports.reduce((acc, element) => {
            if (isIconElementDefined(element)) return acc;
            return [...acc, `<import-element from="./${element}.html"></import-element>`]
          }, []).join(''));

          const nextIter = iter + 1;
          if (importElements[nextIter]) {
            requestAnimationFrame(() => renderElement(nextIter));
          } else {
            globalState.set('unicons-loaded-icons', {
              ...getLoadedIcons(),
              [iconId]: true
            });

            localState.set('icon-import', '');
            renderIconElements();
          }
        };

        const hasLoaded = !!getLoadedIcons()?.[iconId];
        if (!hasLoaded) {
          renderElement();
        } else {
          renderIconElements();
        }
      </script>
    </listen-event>
    <listen-event mounted>
      <send-event name="selected-icon-changed"></send-event>
    </listen-event>
    <listen-event statechanged="unicons-selected-icon">
      <send-event name="selected-icon-changed"></send-event>
    </listen-event>
  </element-flow>
  <template>
    <style>
      :host {
        max-height: 100vh;
        min-height: 100vh;
        width: 100%;
        overflow-y: auto;
        padding: 12px;
      }

      .icon-list {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        justify-content: flex-start;
        gap: 12px;
      }

      .loader {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
    </style>
    <slot name="#icon-import"></slot>
    <is-hidden value="#is-loading" eq="true">
      <div class="icon-list">
        <slot name="#icon-render"></slot>
      </div>
    </is-hidden>

    <is-visible value="#is-loading" eq="true">
      <div class="loader">
        <img loading="lazy" src="/assets/loader.gif" alt="Loading..." />
      </div>
    </is-visible>
  </template>
</custom-element>
